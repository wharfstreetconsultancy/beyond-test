<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Suroor Fashions - Marketplace</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="css/bootstrap.css">
    <link rel="stylesheet" href="css/header.css">
    <link rel="stylesheet" href="css/footer.css">
    <link rel="stylesheet" href="css/main.css">
    <link href="https://fonts.googleapis.com/css?family=Montserrat" rel="stylesheet">
    <link rel="stylesheet" href="css/font-awesome.min.css">
    <link rel='shortcut icon' type='image/x-icon' href='img/favicon.jpg'/>
  </head>
  <body>
  	<div class="container-fluid">
  		<div class="row">
  			<div class="col-sm-1 header">
  				<div class="col-xs-1 col-md-1 col-lg-1 text-center">
  					<a href="/"><img src="img/SVGlogo.svg" class="img" alt="Suroor Fashions - Marketplace"></a>
  				</div>
  			</div>
  		</div>
    </div>
  	<nav class="navbar navbar-default">
  		  <div class="container-fluid nav-con">
  			<div class="navbar-header">
  				<div class="col-sm-1 header">
  				  <button type="button" class="navbar-toggle x collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1" aria-expanded="false">
  					<span class="sr-only">Toggle navigation</span>
  					<span class="icon-bar"></span>
  					<span class="icon-bar second-bar"></span>
  				  </button>
  			  	</div>
  			</div>
  			<div class="collapse navbar-collapse cool-nav" id="bs-example-navbar-collapse-1">
  			  <ul class="myNav nav navbar-nav">
				<li><a href="shop.html">Shop<span class="sr-only">(current)</span></a></li>
  				<li><a href="about.html">About Us<span class="sr-only">(current)</span></a></li>
  				<li><a href="contact.html">Contact</a></li>
  				<li><span id="customer_management"></span></li>
  				<li><span id="cart_management"></span></li>
  			  </ul>
  			</div>
  		  </div>
    </nav>

	<div class="body">
		<div class="container">
			<div class="col-lg-8 col-lg-offset-2">
				<div class="panel panel-primary">
					<div class="panel-heading">
						<div id="cart_title" class="col-lg-8 col-lg-offset-1"></div>
						<div id="paypal-button" class="col-lg-3"></div>
					</div>
					<div class="panel-body">
						<div id="cart_cost_summary" class="row"></div>
						<!-- div id="paypal-button"></div -->
						<div id="cart_inventory" class="row"></div>
					</div>
					<div class="panel-footer">
					</div>
				</div>
			</div>
		</div>
	</div>

    <footer>
      <div class="container-fluid">
        <div class="footer">
          <p class="copyright">&copy; 2017 Suroor Fashions | All Rights Reserved</p>
          <p class="links"><a href="#">Terms of use </a></p>
          <span class="links">|</span>
          <p class="links"><a href="#">Privacy Policy </a></p>
          <span class="links">|</span>
          <p class="links"><a href="#">Sales & Return Policy</a></p>
        </div>
      </div>
    </footer>

		<!-- Latest compiled and minified JavaScript -->
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.form/3.51/jquery.form.min.js"></script>
		<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
		<script src="https://www.paypalobjects.com/api/checkout.js"></script>
		<script src="https://js.braintreegateway.com/web/3.22.2/js/client.min.js"></script>
		<script src="https://js.braintreegateway.com/web/3.22.2/js/paypal-checkout.min.js"></script>
		<script>
var latestCart = {latest.cart};
$(document).ready(function() {

	$("#customer_management").load("js/customer.js");
	$("#cart_management").load("js/cart.js");
	
	if(latestCart) {
		document.getElementById("cart_inventory").innerHTML += '<div class="col-lg-2">Quantity</div><div class="col-lg-2">Product</div><div class="col-lg-2">Size</div><div class="col-lg-2">Color</div><div class="col-lg-2">Per-Item Cost</div><div class="col-lg-2">Total Cost</div>';
		console.log("Latest cart: "+JSON.stringify(latestCart));
		var totalItems = 0;
		var totalCost = 0.00;
		for(var cartItem of latestCart.items) {
			
			document.getElementById("cart_inventory").innerHTML += '<div class="col-lg-2">'+cartItem.quantity+'</div><div class="col-lg-2">'+cartItem.productName+'</div><div class="col-lg-2">'+cartItem.size+'</div><div class="col-lg-2">'+cartItem.color+'</div><div class="col-lg-2">'+cartItem.cost+'</div><div class="col-lg-2">'+cartItem.cost+'</div>';
			totalItems += cartItem.quantity;
			totalCost += cartItem.cost;
		}
		document.getElementById("cart_title").innerHTML = 'Your Cart Items...';
		document.getElementById("cart_cost_summary").innerHTML = totalItems+' item(s) @ ($'+totalCost.toFixed(2)+')';


		var customer = sessionStorage.getItem('customer');

		if(customer) {

			customer = JSON.parse(customer);
			console.log("Customer about to checkout: "+JSON.stringify(customer));
			$.ajax({

				url: '/client_token',
				type: 'get',
				dataType: 'json',
				error: function (xhr) {
	
					console.log("Failed to get payment gateway client token: "+JSON.stringify(xhr));
				},
				success: function (response) {
	
					console.log("Got payment gateway client token: "+JSON.stringify(response.clientToken));
					// Create a client.
					braintree.client.create({authorization: response.clientToken}, function (clientErr, clientInstance) {
	
						// Stop if there was a problem creating the client.
						// This could happen if there is a network error or if the authorization
						// is invalid.
						if (clientErr) {
	
							console.error('Error creating client:', clientErr);
							return;
						}
	
						// Create a PayPal Checkout component.
						braintree.paypalCheckout.create({client: clientInstance}, function (paypalCheckoutErr, paypalCheckoutInstance) {
	
							// Stop if there was a problem creating PayPal Checkout.
							// This could happen if there was a network error or if it's incorrectly
							// configured.
							if (paypalCheckoutErr) {
								console.error('Error creating PayPal Checkout:', paypalCheckoutErr);
								return;
							}
	
							// Set up PayPal with the checkout.js library
							paypal.Button.render({
	
								env: 'sandbox', // or 'sandbox'
								commit: true, // This will add the transaction amount to the PayPal button
								payment: function () {

									console.log("CUSTOMER: "+JSON.stringify(customer));
									console.log("ADDRESS: "+JSON.stringify(customer.address));

									return paypalCheckoutInstance.createPayment({
										flow: 'checkout',
										amount: totalCost,
										currency: 'USD',
										enableShippingAddress: true,
										shippingAddressEditable: false,
										shippingAddressOverride: {
											recipientName: customer.given_name+' '+customer.family_name,
											line1: customer.address.line1,
											line2: customer.address.line2,
											city: customer.address.city,
											countryCode: 'US',
											postalCode: customer.address.zip,
											state: customer.address.state,
											phone: customer.address.phone_number
										}
									});
								},
								onAuthorize: function (data, actions) {

									return paypalCheckoutInstance.tokenizePayment(data).then(function (payload) {

										console.log("Payment gateway request data: "+JSON.stringify(data));
										console.log("Payment gateway request actions: "+JSON.stringify(actions));
										console.log("Payment gateway response: "+JSON.stringify(payload));

										// Submit payload.nonce to server
										$.ajax({
											url: '/transaction',
											type: 'post',
											dataType: 'json',
											data: {
												amount: totalCost,
												nonce: payload.nonce,
												shippingAddress: payload.details.shippingAddress
											},
											error: function (xhr) {

												console.log('Payment transaction failed: '+JSON.stringify(xhr.responseJSON.error));

												document.getElementById("cart_cost_summary").innerHTML = '';
												document.getElementById("paypal-button").innerHTML = '';
												document.getElementById("cart_title").innerHTML = 'Order Summary...';
												document.getElementById("cart_inventory").innerHTML = 'Status: Failed<br>';
												document.getElementById("cart_inventory").innerHTML += 'Error message(s):<br>';
												document.getElementById("cart_inventory").innerHTML += '<ul>';
												for(var errorMessage of xhr.responseJSON.error.message) {
													document.getElementById("cart_inventory").innerHTML += '<li>'+errorMessage+'</li>';
												}
												if(xhr.responseJSON.error.orderId) {document.getElementById("cart_inventory").innerHTML += 'Suroor Order Ref: '+xhr.responseJSON.error.orderId;}
												if(xhr.responseJSON.error.paymentId) {document.getElementById("cart_inventory").innerHTML += 'Paypal Payment Ref: '+xhr.responseJSON.error.paymentId;}
												document.getElementById("cart_inventory").innerHTML += '</ul>';
											},
											success: function (response) {
								
												console.log("Created payment transaction: "+JSON.stringify(response));

												document.getElementById("cart_cost_summary").innerHTML = '';
												document.getElementById("paypal-button").innerHTML = '';
												document.getElementById("cart_title").innerHTML = 'Order Summary...';
												document.getElementById("cart_inventory").innerHTML = 'Status: '+response.transaction.message+'<br>';
												document.getElementById("cart_inventory").innerHTML += 'Suroor Order Ref: '+response.transaction.orderId+'<br>';
												document.getElementById("cart_inventory").innerHTML += 'Paypal Payment Ref: '+response.transaction.paymentId+'<br>';
												document.getElementById("cart_clear").click();
											}
										});
									});
								},
								onCancel: function (data) {

									console.log('checkout.js payment cancelled', JSON.stringify(data, 0, 2));
								},
								onError: function (error) {

									if(error) {error = JSON.stringify(error);}
									if(!error || error.length == 0 || error == '{}') {error = 'Unexpected error.';}
									console.log("Payment authorisation failed: "+error);
									document.getElementById("cart_cost_summary").innerHTML = '';
									document.getElementById("paypal-button").innerHTML = '';
									document.getElementById("cart_title").innerHTML = 'Order Status...';
									document.getElementById("cart_inventory").innerHTML = error;
								}
							}, '#paypal-button').then(function () {
							// The PayPal button will be rendered in an html element with the id
							// `paypal-button`. This function will be called when the PayPal button
							// is set up and ready to be used.
								return true;
							});
						});
					});
				}
			});
		}
	} else {

		document.getElementById("cart_inventory").innerHTML = '...is currently empty. Please browse our store for some great products!';
	}
});
		</script>
	</body>
</html>

<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Suroor Fashions - Product Management</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="css/bootstrap.css">
    <link rel="stylesheet" href="css/header.css">
    <link rel="stylesheet" href="css/footer.css">
    <link rel="stylesheet" href="css/main.css">
    <link href="https://fonts.googleapis.com/css?family=Montserrat" rel="stylesheet">
    <link rel="stylesheet" href="css/font-awesome.min.css">
    <link rel='shortcut icon' type='image/x-icon' href='img/favicon.jpg'/>
  </head>
  <body onLoad="{onload.action}">
    <!------------------------------ Header --------------------------->
    <!--This is the Header Content-->
  	<div class="container-fluid">
  		<div class="row">
  			<div class="col-sm-1 header">
  				<div class="col-xs-1 col-md-1 col-lg-1 text-center">
  					<a href="/"><img src="img/SVGlogo.svg" class="img" alt="Suroor Fashions - Product Management"></a>
  				</div>
  			</div>
  		</div>
    </div>
  	<nav class="navbar navbar-default">
  		  <div class="container-fluid nav-con">
  			<!--Brand and toggle get grouped for better mobile display-->
  			<div class="navbar-header">
  				<div class="col-sm-1 header">
  				  <button type="button" class="navbar-toggle x collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1" aria-expanded="false">
  					<span class="sr-only">Toggle navigation</span>
  					<span class="icon-bar"></span>
  					<span class="icon-bar second-bar"></span>
  				  </button>
  			  	</div>
  			</div>
  			<!--Collect the nav links, forms, and other content for toggling-->
  			<div class="collapse navbar-collapse cool-nav" id="bs-example-navbar-collapse-1">Product Management</div>
  		  </div>
    </nav>

    <!---------------------------Body ------------------------->
    <div class="body">
        <!-- Title -->
        <div class="row">
            <form id="product_details" action="/" method="post" enctype="multipart/form-data">
                <input id="id" type="hidden" name="id">
                <input id="creationTimestamp" type="hidden" name="creationTimestamp">
                <input id="images" type="hidden" name="images">
                <div class="col-lg-12">
                    <table width="100%"><tr><td>
                        <h1>Product Editor</h1>
                    </td><td align="right">
                        <input id="post" name="action" type="submit" class="btn btn-primary" value="Create"><input id="put" name="action" type="submit" class="btn btn-primary" value="Update"><input id="delete" name="action" type="submit" class="btn btn-primary" value="Delete"><input id="reset_forms" type="reset" class="btn btn-primary" value="Clear" onclick="clearAllForms()"><br>
                    </td></tr></table>
                </div>
                <div class="caption">
                    {user.prompt}<br>
                </div>
<table width="100%"><tr><td align="left" valign="top" width="25%">
                <div class="caption">
                    <b>Name:</b><br>
                    <input id="name" type="text" name="name"><br>
                </div>
                <div class="caption">
                    <b>Description:</b><br>
                    <input id="description" type="text" name="description"><br>
                </div>
                <div class="caption">
                    <b>Price:</b><br>
                    <input id="price" type="text" name="price"><br>
                </div>
</td><td align="left" valign="top" width="25%">
                <div class="caption">
                    <b>Type:</b><br>
                    <input id="type_clothing" type="radio" name="type" value="CLOTHING" checked> Clothing<br>
                    <input id="type_jewellery" type="radio" name="type" value="JEWELLERY"> Jewellery<br>
                </div>
                <div class="caption">
                    <b>Status:</b><br>
                    <input id="promoted" type="checkbox" name="promoted" value="true"> On Promotion<br>
                </div>
            </form>
</td><td align="left" valign="top" width="50">
            <img id="selected_image" width="50"/>
</td><td align="left" valign="top">
            <form id="product_image"  method="post" enctype="multipart/form-data">
                <input id="image_loc" type="hidden" name="image_loc">
                <input id="image_tag" type="hidden" name="image_tag">
                <div class="caption">
                    <table id="image_list">
                    </table>
                </div>
            </form>
</td></tr></table>
        </div>
        <hr>
        <div class="row">
<form id="product_catalog">
<table width="100%"><tr><td align="left" valign="top" width="50%">
            <div class="col-lg-12">
                <h1>Current Clothing Catalog</h1>
                **denotes product to be displayed in showcase carousel<br>
                {products.list.clothing}
            </div>
</td><td align="left" valign="top" width="50%">
            <div class="col-lg-12">
                <h1>Current Jewellery Catalog</h1>
                **denotes product to be displayed in showcase carousel<br>
                {products.list.jewellery}
            </div>
</td></tr></table>
</form>
        </div>
    </div>

    <!------------------------------- Footer --------------------->
    <footer>
      <div class="container-fluid">
        <div class="footer">
          <p class="copyright">&copy 2017 Suroor Fasions | All Rights Reserved</p>
          <p class="links"><a href="#">Terms of use </a></p>
          <span class="links">|</span>
          <p class="links"><a href="#">Privacy Policy </a></p>
          <span class="links">|</span>
          <p class="links"><a href="#">Sales & Return Policy</a></p>
        </div>
      </div>
    </footer>

    <!-- Latest compiled and minified JavaScript -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
    <script src="http://cdnjs.cloudflare.com/ajax/libs/jquery.form/3.51/jquery.form.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
    <script>
function reloadProduct(product, callback) {
	$.get('/product/'+product.id, function(product, status){
		displayProduct(product, function () {
			selectProduct(JSON.parse(document.getElementById(product.id).value), function() {
				callback();
			});
		});
	});
}

function displayProduct(product, callback) {
	document.getElementById(product.id+'_div').innerHTML = '<input id=\''+product.id+'\' type=\'radio\' name=\'product\' value=\''+JSON.stringify(product)+'\' onclick=\'selectProduct(JSON.parse(this.value));\'> '+product.name+'</input><br>Created on...<br>';
	callback();
}

function selectProduct(selectedProduct, callback) {
	console.log("Product just selected: "+JSON.stringify(selectedProduct));
	document.getElementById('id').value = selectedProduct.id;
	document.getElementById('creationTimestamp').value = selectedProduct.creationTimestamp;
	document.getElementById('name').value = selectedProduct.name;
	document.getElementById('description').value = selectedProduct.description;
	document.getElementById('price').value = selectedProduct.price;
        document.getElementById('product_image').action = '/product/'+selectedProduct.id+'/image';
        document.getElementById('image_list').innerHTML = '<tr><td colspan=\'2\'><b>New Image</b><input id=\'image_files\' name=\'image_files\' type=\'file\'/></td><td></td><td><input id=\'create\' name=\'action\' type=\'submit\' class=\'btn btn-primary\' value=\'Upload\'></td></tr>';
	var imageCounter = 1;
	if(selectedProduct.images) {
		for(var image of selectedProduct.images) {
			document.getElementById('image_list').innerHTML += '<tr><td><input id=\''+image.tag+'\' type=\'radio\' name=\'selected_image\' value=\''+JSON.stringify(image)+'\' onclick=\'selectImage(JSON.parse(this.value))\'> Image '+(imageCounter++)+'</input></td><td><div id=\''+image.tag+'_default_cell\'>&nbsp;</div></td><td></td></tr>';
		}
	}
	document.getElementById('type_'+selectedProduct.type.toLowerCase()).checked = true;
	document.getElementById('promoted').checked = selectedProduct.promoted;
	document.getElementById(selectedProduct.id).checked = true;
	if(callback) {
		callback();}
	else {
		getDefaultImage(selectedProduct, function (defaultImage) {
			selectImage(defaultImage);
		});
	}
}

function selectImage(selectedImage) {
        console.log("Image just selected: "+JSON.stringify(selectedImage));
        document.getElementById('selected_image').src = selectedImage.location;
        document.getElementById('image_loc').value = selectedImage.location;
        document.getElementById('image_tag').value = selectedImage.tag;
	getSelectedProduct(function (selectedProduct) {
                for(var image of selectedProduct.images) {
                        document.getElementById(image.tag+'_default_cell').innerHTML = '&nbsp';
		}
        	document.getElementById(selectedImage.tag+'_default_cell').innerHTML = '<input id=\'default_image\' type=\'checkbox\' value=\''+selectedImage.tag+'\' onchange=\'changeDefaultImage(this)\'> (default image)</input>';
		document.getElementById('default_image').checked = selectedImage.isDefault;
		document.getElementById(selectedImage.tag).checked = true;
        });
}

function getSelectedProduct(callback) {
        for(var product of document.getElementById('product_catalog')) {
                if(product.checked) {
                        console.log("Currently selected product: "+product.value);
			callback(JSON.parse(product.value));
                }
        }
}

function getSelectedImage(callback) {
        for(var image of document.getElementsByName('selected_image')) {
                if(image.checked) {
                        console.log("Currently selected image: "+image.value);
                        callback(JSON.parse(image.value));
                }
        }
}

function getDefaultImage(product, callback) {
        if(product.images) {
		for(var image of product.images) {
	                if(image.isDefault) {
                        	callback(image);
                	}
        	}
	}
}

function changeDefaultImage(newDefaultImageCheckbox) {
	if(newDefaultImageCheckbox.checked == false) {
		alert("Must have default image at all times");
		newDefaultImageCheckbox.checked = true;
		return false;
	}
	getSelectedProduct(function (product) {
		for(var image of product.images) {
			if(image.tag == newDefaultImageCheckbox.value) {image.isDefault = true;}
			else {image.isDefault = false;}
		}
		displayProduct(product, function() {
			selectProduct(product);
		});
	});
}

function clearAllForms() {
	for(var form of document.forms) {
		console.log("Clearing form: "+JSON.stringify(form.id));
		form.reset();
	}
	document.getElementById('image_list').innerHTML = '';
	document.getElementById('selected_image').src = '';
}

$(document).ready(function() {
	$('#product_image').submit(function () {
        	$('#status').empty().text('File is uploading...');
        	$(this).ajaxSubmit({
			error: function (xhr) {
				status('Error: ' + xhr.status);
				console.log("File upload error: "+xhr.status);
			},
			success: function (image) {
				$('#status').empty().text(image);
				console.log("File upload success: "+JSON.stringify(image));
				getSelectedProduct(function (selectedProduct) {
					reloadProduct(selectedProduct, function () {
						selectImage(JSON.parse(document.getElementById(image.tag).value));
                                        });
				});
			}
		});
		return false;
	});
        $('#product_details').submit(function () {
		getSelectedProduct(function (product) {
			document.getElementById('images').value = JSON.stringify(product.images);
		});
                return true;
        });
});
    </script>
  </body>
</html>
